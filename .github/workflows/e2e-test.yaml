name: E2E Tests
on:
#   workflow_dispatch:
    pull_request:
        types: [opened, reopened, synchronize]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    env:
        DJANGO_ENV: local
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        POSTGRES_DB: blog
        POSTGRES_PASSWORD: securepassword
        POSTGRES_USER: user

    services:
      postgres:
        image: postgres:16.4
        env:
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 8s
          --health-retries 5

    steps:
      - uses: actions/checkout@master
      - id: setup
        uses: ./.github/actions/install-deps

      - name: Check Database Connection
        run: |
            PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h 127.0.0.1 -p 5432 -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c '\l'

      - name: Apply Migrations
        env:
            SECRET_KEY: ${{ secrets.SECRET_KEY }}
            POSTGRES_DB: blog
            POSTGRES_PASSWORD: securepassword
            POSTGRES_USER: user
        run: |
            set -v
            make migrate

      - name: Start Django server
        continue-on-error: false
        run: |
          set -v
          make dev &

      - name: Run your tests
        run: |
          set -v
          pip install playwright
          playwright install --with-deps chromium
          python e2e/signup.py

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-traces
          path: test-results/
          retention-days: 5
