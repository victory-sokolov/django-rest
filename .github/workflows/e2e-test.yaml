name: E2E Tests
on:
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    env:
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        POSTGRES_DB: blog
        POSTGRES_PASSWORD: securepassword
        POSTGRES_USER: user
        PGHOST: localhost

    services:
      postgres:
        image: postgres:16.4
        env:
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@master
      - id: setup
        uses: ./.github/actions/install-deps

      - name: Run Django Checks
        shell: sh
        run: |
          set -v
          make run-checks

      - name: Check Database Connection
        run: |
            PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h ${{ env.PGHOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c '\l'

      - name: Apply Migrations
        env:
            SECRET_KEY: ${{ secrets.SECRET_KEY }}
            POSTGRES_DB: blog
            POSTGRES_PASSWORD: securepassword
            POSTGRES_USER: user
            POSTGRES_HOST: localhost
        run: |
            set -v
            DJANGO_ENV=development uv run python manage.py migrate

      - name: Start Django server
        continue-on-error: false
        run: |
          set -v
          DJANGO_ENV=development uv run python manage.py runserver || exit 1

      - name: Run your tests
        run: |
          set -v
          pip install playwright
          playwright install --with-deps chromium
          python e2e/test_signup.py

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-traces
          path: test-results/
          retention-days: 5
