# Helm/Kubernetes Validation Pipeline
# Multi-layer validation for Helm charts and K8s manifests

name: Helm/K8s Validation

on:
  pull_request:
    paths:
      - 'infra/k8s/**'
      - '.github/workflows/helm-validation.yml'
      - '.yamllint.yaml'
      - '.pre-commit-config.yaml'
  push:
    branches: [master]
    paths:
      - 'infra/k8s/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  HELM_VERSION: "3.14.0"
  CT_VERSION: "3.9.0"
  KUBECTL_VERSION: "1.29.0"
  KUBECONFORM_VERSION: "0.6.4"
  PLUTO_VERSION: "5.18.4"
  HELMFILE_VERSION: "0.160.0"

jobs:
  # ============================================
  # Stage 1: YAML Syntax Validation
  # ============================================
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: yamllint -c .yamllint.yaml infra/k8s/ --strict

  # ============================================
  # Stage 2: Helm Lint
  # ============================================
  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    needs: yaml-lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Run helm lint on all charts
        working-directory: infra/k8s
        run: |
          for chart in charts/*/; do
            echo "Linting $chart..."
            helm lint "$chart" --strict || exit 1
          done
          echo "Linting umbrella chart..."
          helm lint . --strict || true

  # ============================================
  # Stage 3: Parallel Validation Jobs
  # ============================================
  chart-testing:
    name: Chart Testing
    runs-on: ubuntu-latest
    needs: helm-lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Setup chart-testing
        uses: helm/chart-testing-action@v2.6.1
        with:
          version: ${{ env.CT_VERSION }}

      - name: Run chart-testing lint
        working-directory: infra/k8s
        run: ct lint --config ct.yaml --all

  kubeconform:
    name: K8s Schema Validation
    runs-on: ubuntu-latest
    needs: helm-lint
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install kubeconform
        run: |
          curl -sSfL https://github.com/yannh/kubeconform/releases/download/v${{ env.KUBECONFORM_VERSION }}/kubeconform-linux-amd64.tar.gz | tar -xzf -
          sudo mv kubeconform /usr/local/bin/

      - name: Update Helm dependencies
        working-directory: infra/k8s
        run: helm dependency update charts/apps || true

      - name: Run kubeconform
        working-directory: infra/k8s
        run: |
          helm template charts/apps -f charts/apps/values.yaml --namespace production | \
            kubeconform -summary -kubernetes-version ${{ env.KUBECTL_VERSION }} -skip List \
            -schema-location "crd-schemas/" \
            -schema-location "https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/"

  pluto:
    name: Deprecated API Detection
    runs-on: ubuntu-latest
    needs: helm-lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install pluto
        uses: fairwindsops/pluto/github-action@master

      - name: Update Helm dependencies
        working-directory: infra/k8s
        run: helm dependency update charts/apps || true

      - name: Run pluto
        working-directory: infra/k8s
        run: |
          helm template charts/apps -f charts/apps/values.yaml --namespace production | \
            pluto detect - --target-versions k8s=v${{ env.KUBECTL_VERSION }}

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: helm-lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install checkov
        run: pip install checkov

      - name: Update Helm dependencies
        working-directory: infra/k8s
        run: helm dependency update charts/apps || true

      - name: Render manifests
        working-directory: infra/k8s
        run: |
          helm template charts/apps -f charts/apps/values.yaml --namespace production > /tmp/rendered.yaml

      - name: Run checkov
        run: |
          checkov -f /tmp/rendered.yaml --framework kubernetes --compact --soft-fail

  # ============================================
  # Stage 4: Helmfile Validation
  # ============================================
  helmfile-validate:
    name: Helmfile Validation
    runs-on: ubuntu-latest
    needs: [chart-testing, kubeconform]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install helmfile
        run: |
          curl -sSfL https://github.com/helmfile/helmfile/releases/download/v${{ env.HELMFILE_VERSION }}/helmfile_${{ env.HELMFILE_VERSION }}_linux_amd64.tar.gz | tar -xzf -
          sudo mv helmfile /usr/local/bin/

      - name: Install helm-diff plugin
        run: helm plugin install https://github.com/databus23/helm-diff

      - name: Run helmfile lint
        working-directory: infra/k8s
        run: helmfile lint

  # ============================================
  # Stage 5: Validation Summary
  # ============================================
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [yaml-lint, helm-lint, chart-testing, kubeconform, pluto, security-scan, helmfile-validate]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "::error::One or more validation jobs failed"
            echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| yaml-lint | ${{ needs.yaml-lint.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| helm-lint | ${{ needs.helm-lint.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| chart-testing | ${{ needs.chart-testing.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| kubeconform | ${{ needs.kubeconform.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| pluto | ${{ needs.pluto.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| security-scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| helmfile-validate | ${{ needs.helmfile-validate.result }} |" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "## All Validation Checks Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ YAML syntax valid" >> $GITHUB_STEP_SUMMARY
          echo "✓ Helm charts valid" >> $GITHUB_STEP_SUMMARY
          echo "✓ K8s schemas valid" >> $GITHUB_STEP_SUMMARY
          echo "✓ No deprecated APIs" >> $GITHUB_STEP_SUMMARY
          echo "✓ Security scan passed" >> $GITHUB_STEP_SUMMARY
          echo "✓ Helmfile valid" >> $GITHUB_STEP_SUMMARY
